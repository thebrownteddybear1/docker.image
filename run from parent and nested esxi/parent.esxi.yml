 esxcli system settings kernel set --setting="disableCFOH" --value="TRUE"

        # --- Optional: Set other settings if you wish to be explicit ---
        # These are already FALSE by default on your host, but setting them again ensures the state.
        esxcli system settings kernel set --setting="hyperthreadingMitigation" --value="FALSE"
        esxcli system settings kernel set --setting="forceHyperthreadingMitigation" --value="FALSE"
        esxcli system settings kernel set --setting="hyperthreadingMitigationIntraVM" --value="FALSE"

        echo "Kernel settings updated. A host reboot is required for changes to take effect."


        # 1. Set CPU power policy to HIGH PERFORMANCE (disables frequency scaling)
esxcli system settings advanced set -o /Power/CpuPolicy -s static

# 2. Disable C-States completely (reduces CPU sleep state latency)
esxcli system settings advanced set -o /Power/CState -s false

# 3. Verify Hyper-Threading is active and count threads
esxcli hardware cpu list | grep -E "Cores|Threads"
# Should show: Cores per Socket: 28, Threads per Core: 2, Logical CPUs: 56

esxcli system settings advanced set -o /Power/CpuPolicy -s static


### RUN ON ESXI PARENT

cat > /tmp/check_cpu_details.sh << 'EOF'
#!/bin/sh
echo "=== Detailed CPU Information ==="
echo ""

# Method 1: Use esxcli hardware cpu list with proper formatting
echo "Method 1 - Detailed CPU List:"
esxcli hardware cpu list | tail -20
echo ""

# Method 2: Get global CPU info
echo "Method 2 - Global CPU Stats:"
esxcli hardware cpu global get
echo ""

# Method 3: Check Hyper-Threading specifically
echo "Method 3 - Hyper-Threading Check:"
LOGICAL_CPUS=$(esxcli hardware cpu global get | grep "Logical Processors" | awk '{print $3}')
PHYSICAL_CPUS=$(esxcli hardware cpu global get | grep "Package Count" | awk '{print $3}')
if [ -n "$LOGICAL_CPUS" ] && [ -n "$PHYSICAL_CPUS" ]; then
    echo "Physical CPUs: $PHYSICAL_CPUS"
    echo "Logical CPUs: $LOGICAL_CPUS"
    if [ $LOGICAL_CPUS -gt $PHYSICAL_CPUS ]; then
        echo "✓ Hyper-Threading: ENABLED"
    else
        echo "✗ Hyper-Threading: DISABLED (check BIOS)"
    fi
fi
EOF

chmod +x /tmp/check_cpu_details.sh
/tmp/check_cpu_details.sh


# 1. Check if ESXi can now control power policy
esxcli system settings advanced set -o /Power/CpuPolicy -s high

# 2. Verify the current policy
esxcli system settings advanced list -o /Power/CpuPolicy | grep "String Value"

# 3. Set optimal custom parameters (if 'high' still fails)
esxcli system settings advanced set -o /Power/UseCStates -i 0
esxcli system settings advanced set -o /Power/UsePStates -i 0
esxcli system settings advanced set -o /Power/CStateMaxLatency -i 1
cat > /tmp/verify_power_config.sh << 'EOF'
#!/bin/sh
echo "=== Power Configuration Verification ==="
echo "Time: $(date)"
echo ""

# 1. Show all power settings
echo "1. Current Power Settings:"
echo "   Policy: $(esxcli system settings advanced list -o /Power/CpuPolicy | grep "String Value" | awk '{print $NF}')"
echo "   UseCStates: $(esxcli system settings advanced list -o /Power/UseCStates | grep IntValue | awk '{print $NF}')"
echo "   UsePStates: $(esxcli system settings advanced list -o /Power/UsePStates | grep IntValue | awk '{print $NF}')"
echo "   CStateMaxLatency: $(esxcli system settings advanced list -o /Power/CStateMaxLatency | grep IntValue | awk '{print $NF}') μs"
echo ""

# 2. Check CPU frequency (alternative method)
echo "2. CPU Frequency Check:"
esxcli hardware cpu list | grep "Core Speed" | head -1 | awk '{print "   Current: " $3/1000000 " GHz"}'
echo ""

# 3. Monitor performance impact
echo "3. Performance Monitoring:"
echo "   Logical CPUs: $(esxcli hardware cpu global get | grep "CPU Threads" | awk '{print $3}')"
echo "   Hyper-Threading: $(esxcli hardware cpu global get | grep "Hyperthreading Active" | awk '{print $3}')"
echo ""

# 4. Make settings persistent (survive reboot)
echo "4. Making settings persistent..."
cat > /etc/rc.local.d/power_performance.sh << 'PERSIST'
#!/bin/sh
esxcli system settings advanced set -o /Power/UseCStates -i 0
esxcli system settings advanced set -o /Power/UsePStates -i 0
esxcli system settings advanced set -o /Power/CStateMaxLatency -i 1
exit 0
PERSIST
chmod +x /etc/rc.local.d/power_performance.sh
echo "✓ Settings will persist after reboot"
echo ""

echo "=== CONFIGURATION COMPLETE ==="
echo "Your ESXi host is now optimized for maximum NFS performance."
echo "C-States: Disabled (no CPU sleep)"
echo "P-States: Disabled (no frequency scaling)"
echo "Perfect for consistent 500+ MB/s NFS throughput!"
EOF

chmod +x /tmp/verify_power_config.sh
/tmp/verify_power_config.sh