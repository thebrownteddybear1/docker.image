#!/bin/bash
# Check if iostat is installed, install if missing
if ! command -v iostat &> /dev/null; then
    sudo apt update && sudo apt install -y sysstat &> /dev/null
fi

clear
echo "=================================================================="
echo "      NFS TRIPLE-EXPORT DASHBOARD (NUMA NODE 1 ALIGNED)"
echo "      Time: $(date)"
echo "=================================================================="

echo "1. THREADS & CPU AFFINITY:"
echo "--------------------------"
nfsd_threads=$(pgrep nfsd | wc -l)
# Check if threads are staying on Cores 0-15
on_target=$(ps -eLo psr,comm | grep nfsd | awk '$1 >= 0 && $1 <= 15' | wc -l)
echo "Total threads: $nfsd_threads"
echo "Threads on Cores 0-15: $on_target / $nfsd_threads"
echo ""

echo "2. RAM BUFFER (90GB GOAL):"
echo "--------------------------"
# Dirty: Data in RAM waiting for disk | Writeback: Data currently moving to disk
grep -E "(Dirty|Writeback|Cached)" /proc/meminfo | awk '{print $1, $2/1024 " MB"}'
free -h | head -2
echo ""

echo "3. NFS OPS (V3):"
echo "----------------"
nfsstat -s | grep -A1 "read" | sed 's/readlink//'
echo ""

echo "4. DISK I/O (3x 1.8TB SSDs):"
echo "----------------------------"
# This targets your likely disk names (sdb, sdc, sdd)
iostat -dx 1 1 | grep -E "(Device|sd[b-d])"
echo ""

echo "5. NETWORK LATENCY (RTT):"
echo "-------------------------"
ss -ntip state established '( dport = :2049 or sport = :2049 )' | grep "rtt:" | head -n 3
echo "=================================================================="