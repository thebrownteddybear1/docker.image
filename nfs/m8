#!/bin/bash
# Ensure tools are present
if ! command -v bc &> /dev/null || ! command -v iostat &> /dev/null; then
    sudo apt update && sudo apt install -y bc sysstat &> /dev/null
fi

clear
echo "=================================================================="
echo "      NFS TRIPLE-EXPORT DASHBOARD (NVMe OPTIMIZED)"
echo "      Time: $(date)"
echo "=================================================================="

echo "1. THREADS & CPU AFFINITY:"
echo "--------------------------"
nfsd_threads=$(pgrep nfsd | wc -l)
on_target=$(ps -eLo psr,comm | grep nfsd | awk '$1 >= 0 && $1 <= 15' | wc -l)
echo "Total nfsd threads: $nfsd_threads"
echo "Cores 0-15 Alignment: $on_target / $nfsd_threads"
echo ""

echo "2. RAM BUFFER (90GB GOAL):"
echo "--------------------------"
# Shows exactly how much data is 'stuck' in RAM due to the 80ms latency
grep -E "(Cached|Dirty|Writeback):" /proc/meminfo | awk '{printf "%-15s %10.2f GB\n", $1, $2/1024/1024}'
echo "--------------------------"
free -h | grep "Mem:" | awk '{print "Total: "$2 " | Used: "$3 " | Available: "$7}'
echo ""

echo "3. DISK I/O (NVMe PARALLELISM):"
echo "----------------------------"
# iostat 1 2 gives the real-time delta, ignoring the boot-time average
iostat -dx 1 2 | grep -E "sd[b-d]" | tail -n 3 | awk '{printf "%-10s %-15s %-10s %-10s\n", $1, $10" wkB/s", "Queue: "$22, $NF" %util"}'
echo ""

echo "4. NETWORK VS DISK THROUGHPUT:"
echo "------------------------------"
# Calculate Network Inbound (ens34)
NET_RX1=$(cat /sys/class/net/ens34/statistics/rx_bytes)
sleep 1
NET_RX2=$(cat /sys/class/net/ens34/statistics/rx_bytes)
NET_SPEED=$(( (NET_RX2 - NET_RX1) / 1024 / 1024 ))

# Calculate Disk Outbound (Total of sdb, sdc, sdd)
DISK_STATS=$(iostat -d 1 1 | grep -E "sd[b-d]")
DISK_SPEED=$(echo "$DISK_STATS" | awk '{sum+=$4} END {print sum/1024}')

echo "Network Inbound:  $NET_SPEED MB/s  (Max: 1250 MB/s for 10G)"
echo "Disk Outbound:     $(printf "%.2f" $DISK_SPEED) MB/s (Max: 1500 MB/s for NVMe)"

# Intelligent Status Logic
if (( $(echo "$DISK_SPEED > $NET_SPEED + 5" | bc -l) )); then
    echo "STATUS: [ DRAINING ] - NVMe is clearing the 90GB RAM buffer."
elif (( $(echo "$NET_SPEED > $DISK_SPEED + 5" | bc -l) )); then
    echo "STATUS: [ ABSORBING ] - RAM is soaking up the 80ms network lag."
else
    echo "STATUS: [ IDLE / BALANCED ]"
fi
echo "=================================================================="