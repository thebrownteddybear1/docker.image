services:
  chrony-ntp:
    image: alpine:latest
    container_name: chrony-ntp-server
    restart: unless-stopped
    network_mode: host
    command: >
      /bin/sh -c "
      # Install chrony if not present
      if ! command -v chronyd >/dev/null 2>&1; then
        apk add --no-cache chrony
      fi
      
      # Create configuration directory if it doesn't exist
      mkdir -p /etc/chrony
      
      # Generate chrony configuration
      cat > /etc/chrony/chrony.conf << 'CHRONY_CONFIG'
      # NTP Servers
      server 0.pool.ntp.org iburst
      server 1.pool.ntp.org iburst
      server 2.pool.ntp.org iburst
      server 3.pool.ntp.org iburst
      
      # Allow access
      allow 127.0.0.1
      allow 192.168.0.0/16
      allow 10.0.0.0/8
      
      # Local stratum if all servers fail
      local stratum 10
      
      # Drift file
      driftfile /var/lib/chrony/chrony.drift
      
      # Logging
      logdir /var/log/chrony
      log measurements statistics tracking
      
      # Time adjustments
      makestep 1.0 3
      rtcsync
      CHRONY_CONFIG
      
      # Create data directory
      mkdir -p /var/lib/chrony
      chown chrony:chrony /var/lib/chrony
      
      # Run chronyd in foreground (this keeps container alive)
      exec chronyd -d -f /etc/chrony/chrony.conf
      "
    cap_add:
      - SYS_TIME
      - SYS_NICE
    volumes:
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Asia/Singapore