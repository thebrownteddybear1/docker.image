#!/bin/bash
# Ensure sysstat is present for Section 4
if ! command -v iostat &> /dev/null; then
    sudo apt update && sudo apt install -y sysstat &> /dev/null
fi

clear
echo "=================================================================="
echo "      NFS TRIPLE-EXPORT DASHBOARD (IO ACCELERATED)"
echo "      Time: $(date)"
echo "=================================================================="

echo "1. THREADS & CPU AFFINITY:"
echo "--------------------------"
nfsd_threads=$(pgrep nfsd | wc -l)
on_target=$(ps -eLo psr,comm | grep nfsd | awk '$1 >= 0 && $1 <= 15' | wc -l)
echo "Total nfsd threads: $nfsd_threads"
echo "Cores 0-15 Alignment: $on_target / $nfsd_threads"
echo ""

echo "2. RAM BUFFER (90GB GOAL):"
echo "--------------------------"
grep -E "(Cached|Dirty|Writeback):" /proc/meminfo | awk '{printf "%-15s %10.2f GB\n", $1, $2/1024/1024}'
echo "--------------------------"
free -h | grep "Mem:" | awk '{print "Total: "$2 " | Used: "$3 " | Available: "$7}'
echo ""

echo "3. DISK I/O (QUEUE DEPTH: 256):"
echo "----------------------------"
# Showing Device, Write Speed, and the Queue Size (aqu-sz)
iostat -dx 1 1 | grep -E "(Device|sd[b-d])" | awk '{printf "%-10s %-15s %-10s %-10s\n", $1, $10" wkB/s", "Queue: "$22, $NF" %util"}'
echo ""

echo "4. NETWORK VS DISK THROUGHPUT:"
echo "------------------------------"
# Calculate network RX speed (Inbound from Clients)
NET_RX1=$(cat /sys/class/net/ens34/statistics/rx_bytes)
sleep 1
NET_RX2=$(cat /sys/class/net/ens34/statistics/rx_bytes)
NET_SPEED=$(( (NET_RX2 - NET_RX1) / 1024 / 1024 ))

# Calculate total Disk Write speed
DISK_SPEED=$(iostat -d 1 1 | grep -E "sd[b-d]" | awk '{sum+=$4} END {print sum/1024}')

echo "Network Inbound:  $NET_SPEED MB/s"
echo "Disk Outbound:     $(printf "%.2f" $DISK_SPEED) MB/s"

if [ "$NET_SPEED" -gt "0" ] && [ "$(echo "$DISK_SPEED < 1" | bc)" -eq 1 ]; then
    echo